<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Doxygen Fortran Example: Newton.f90 Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Modules</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
<h1>Newton.f90</h1><a href="Newton_8f90.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">!*****************************************************************************</span>
<a name="l00002"></a>00002 <span class="comment">! Module to perform Newton Iteration in one of three modes: QR decomp, line </span>
<a name="l00003"></a>00003 <span class="comment">! search, or normal Newton Iteration. </span>
<a name="l00004"></a>00004 <span class="comment">!******************************************************************************</span>
<a name="l00005"></a>00005 <span class="comment">! REQUIRED FILES:</span>
<a name="l00006"></a>00006 <span class="comment">! PRECISION_VARS.F90        *DEFINES PRECISION FOR ALL VARIABLES</span>
<a name="l00007"></a>00007 <span class="comment">! QR_MODULE.F90             *CONTAINS QR ROUTINES</span>
<a name="l00008"></a>00008 <span class="comment">! CONTROL_VARIABLES.F90     *ONTAINS VARIABLES USED IN THE PROGRAM</span>
<a name="l00009"></a>00009 <span class="comment">! ILUT_MODULE.F90           *CONTAINS ROUTINES TO PERFORM LU DECOMPOSITION</span>
<a name="l00010"></a>00010 <span class="comment">! JACOBIAN_CSR_MOD.F90      *ALLOCATES JACOBIAN CSR VARIABLES</span>
<a name="l00011"></a>00011 <span class="comment">! PROBLEMSUB.F90            *DEFINES WHICH PROBLEM IS RELATED TO USER INPUT</span>
<a name="l00012"></a>00012 <span class="comment">!******************************************************************************</span>
<a name="l00013"></a><a class="code" href="namespaceNewton.html">00013</a>       <span class="keyword">module</span> Newton
<a name="l00014"></a>00014             
<a name="l00015"></a>00015       use <span class="keywordflow">precision_vars</span>, only:wp
<a name="l00016"></a>00016 
<a name="l00017"></a>00017       implicit none; <span class="keywordtype">save</span>
<a name="l00018"></a>00018       
<a name="l00019"></a>00019       <span class="keywordtype">public</span> :: <a class="code" href="namespaceNewton.html#ac0222c3dd5b4ca0f261e769a9f9e3693">Newton_Iteration</a>
<a name="l00020"></a>00020       <span class="keywordtype">private</span>      
<a name="l00021"></a>00021       
<a name="l00022"></a>00022       <span class="keyword">contains</span>    
<a name="l00023"></a>00023 <span class="comment">!==============================================================================      </span>
<a name="l00024"></a>00024 <span class="comment">!  PERFORMS NEWTON ITERATION</span>
<a name="l00025"></a><a class="code" href="namespaceNewton.html#ac0222c3dd5b4ca0f261e769a9f9e3693">00025</a>       <span class="keyword">subroutine </span><a class="code" href="namespaceNewton.html#ac0222c3dd5b4ca0f261e769a9f9e3693">Newton_Iteration</a>(iprob,L,ep,dt,nveclen,time,aI,icount,k)
<a name="l00026"></a>00026       
<a name="l00027"></a>00027       use <span class="keywordflow">control_variables</span>, only: temporal_splitting,jac_case,uvec,usum,xjac
<a name="l00028"></a>00028 
<a name="l00029"></a>00029       <span class="keywordtype">integer</span>, <span class="keywordtype">parameter</span> :: iter_max=20
<a name="l00030"></a>00030       <span class="keywordtype">logical</span>, <span class="keywordtype">parameter</span> :: Line_search=.false. <span class="comment">!set to TRUE for line search</span>
<a name="l00031"></a>00031       <span class="keywordtype">logical</span>, <span class="keywordtype">parameter</span> :: QR=.false. <span class="comment">!set to TRUE for QR factorization</span>
<a name="l00032"></a>00032 
<a name="l00033"></a>00033       <span class="keywordtype">integer</span>,  <span class="keywordtype">intent(in   )</span> :: iprob,L
<a name="l00034"></a>00034       <span class="keywordtype">real(wp)</span>, <span class="keywordtype">intent(in   )</span> :: ep,dt
<a name="l00035"></a>00035       <span class="keywordtype">integer</span>,  <span class="keywordtype">intent(in   )</span> :: nveclen
<a name="l00036"></a>00036       <span class="keywordtype">real(wp)</span>, <span class="keywordtype">intent(in   )</span> :: time,aI
<a name="l00037"></a>00037       <span class="keywordtype">integer</span>,  <span class="keywordtype">intent(inout)</span> :: icount
<a name="l00038"></a>00038       <span class="keywordtype">integer</span>,  <span class="keywordtype">intent(  out)</span> :: k
<a name="l00039"></a>00039       
<a name="l00040"></a>00040       <span class="keywordtype">integer</span>                              :: i,j  <span class="comment">!Do loop variables</span>
<a name="l00041"></a>00041       <span class="keywordtype">real(wp)</span>, <span class="keywordtype">dimension(nveclen)         </span>:: Rnewton,uveciter<span class="comment">!Newton </span>
<a name="l00042"></a>00042       <span class="keywordtype">real(wp)</span>, <span class="keywordtype">dimension(nveclen,nveclen) </span>:: xjacinv <span class="comment">!Jacobian</span>
<a name="l00043"></a>00043 
<a name="l00044"></a>00044 <span class="comment">!------------------------------------------------------------------------------</span>
<a name="l00045"></a>00045       temporal_select: <span class="keyword">select</span> <span class="keyword">case</span>(temporal_splitting)
<a name="l00046"></a>00046         <span class="keyword">case</span>(<span class="stringliteral">&apos;EXPLICIT&apos;</span>)
<a name="l00047"></a>00047           <span class="keyword">do</span> k = 1,iter_max
<a name="l00048"></a>00048             icount = icount + 1
<a name="l00049"></a>00049             uveciter(:) = <a class="code" href="namespacecontrol__variables.html#af26d46d355bee6c749bf25537333f463">uvec</a>(:)
<a name="l00050"></a>00050             <a class="code" href="namespacecontrol__variables.html#af26d46d355bee6c749bf25537333f463">uvec</a>(:)=<a class="code" href="namespacecontrol__variables.html#adb75fde9a143a0e98e889020a87a9f4c">usum</a>(:)
<a name="l00051"></a>00051             <span class="keyword">if</span>(<a class="code" href="namespaceNewton.html#aef423e4c07ae003b74792dc1b26cea6c">check_exit</a>(uveciter,k)) exit            
<a name="l00052"></a>00052           <span class="keyword">enddo</span>   
<a name="l00053"></a>00053         <span class="keyword">case</span> default <span class="comment">!IMEX or IMPLICIT</span>
<a name="l00054"></a>00054           Jac_select: <span class="keyword">select</span> <span class="keyword">case</span>(Jac_case)
<a name="l00055"></a>00055             <span class="keyword">case</span>(<span class="stringliteral">&apos;SPARSE&apos;</span>)
<a name="l00056"></a>00056               <span class="keyword">do</span> k = 1,iter_max
<a name="l00057"></a>00057                 icount = icount + 1
<a name="l00058"></a>00058                 uveciter(:) = <a class="code" href="namespacecontrol__variables.html#af26d46d355bee6c749bf25537333f463">uvec</a>(:) <span class="comment">!store old uvec</span>
<a name="l00059"></a>00059 
<a name="l00060"></a>00060                 Rnewton=<a class="code" href="namespaceNewton.html#ad1d75574149095632fdf22abe98107da">Build_Rnewton</a>(ep,dt,time,aI,iprob,L)
<a name="l00061"></a>00061                 call <a class="code" href="namespaceNewton.html#a52bc9902166475d40c85f9e38bc2762f">Build_Jac</a>(ep,dt,time,aI,iprob,L)
<a name="l00062"></a>00062               
<a name="l00063"></a>00063                 call <a class="code" href="namespaceNewton.html#a5adc17d0f2ed00ec420a7d37c5ac6aa8">LU_solver</a>(Rnewton)
<a name="l00064"></a>00064                 
<a name="l00065"></a>00065                 <span class="keyword">if</span>(<a class="code" href="namespaceNewton.html#aef423e4c07ae003b74792dc1b26cea6c">check_exit</a>(uveciter,k)) exit
<a name="l00066"></a>00066                             
<a name="l00067"></a>00067               <span class="keyword">enddo</span>  
<a name="l00068"></a>00068             <span class="keyword">case</span>(<span class="stringliteral">&apos;DENSE&apos;</span>)
<a name="l00069"></a>00069               <span class="keyword">if</span> (Line_search) <span class="keyword">then</span>
<a name="l00070"></a>00070                 call <a class="code" href="namespaceNewton.html#aa2841efcdb8dfb34b1a57b88229f8e4c">newt_line_search</a>(iprob,L,ep,dt,nveclen,time,aI,icount,k)    
<a name="l00071"></a>00071               <span class="keyword">else</span>
<a name="l00072"></a>00072                 <span class="keyword">do</span> k = 1,iter_max
<a name="l00073"></a>00073                   icount = icount + 1
<a name="l00074"></a>00074                   uveciter(:) = <a class="code" href="namespacecontrol__variables.html#af26d46d355bee6c749bf25537333f463">uvec</a>(:) <span class="comment">!store old uvec   </span>
<a name="l00075"></a>00075                               
<a name="l00076"></a>00076                   Rnewton=<a class="code" href="namespaceNewton.html#ad1d75574149095632fdf22abe98107da">Build_Rnewton</a>(ep,dt,time,aI,iprob,L)
<a name="l00077"></a>00077                   call <a class="code" href="namespaceNewton.html#a52bc9902166475d40c85f9e38bc2762f">Build_Jac</a>(ep,dt,time,aI,iprob,L)
<a name="l00078"></a>00078                   
<a name="l00079"></a>00079                   <span class="keyword">if</span> (nveclen&gt;4 .and. .not. QR) <span class="keyword">then</span> <span class="comment">!No explicit inverse</span>
<a name="l00080"></a>00080                     call <a class="code" href="namespaceNewton.html#a87f5936737bd590d30d903cc00524ef8">Convert_to_CSR</a>(<a class="code" href="namespacecontrol__variables.html#afae70ecf2800b85b5556f11ef27e1083">xjac</a>) <span class="comment">!convert dense xjac to csr</span>
<a name="l00081"></a>00081                     call <a class="code" href="namespaceNewton.html#a5adc17d0f2ed00ec420a7d37c5ac6aa8">LU_solver</a>(Rnewton)
<a name="l00082"></a>00082                     
<a name="l00083"></a>00083                   elseif (nveclen&gt;4 .and. QR) <span class="keyword">then</span> <span class="comment">!QR factorization</span>
<a name="l00084"></a>00084                     call <a class="code" href="namespaceNewton.html#a7401a28af829eff4c6cf2028df648521">QR_decomp</a>(<a class="code" href="namespacecontrol__variables.html#afae70ecf2800b85b5556f11ef27e1083">xjac</a>,nveclen,rnewton) 
<a name="l00085"></a>00085                      
<a name="l00086"></a>00086                   elseif (nveclen&lt;=4) <span class="keyword">then</span> <span class="comment">!Explicit inverse</span>
<a name="l00087"></a>00087                     xjacinv=<a class="code" href="namespaceNewton.html#a7ac79898ae2c29247d9712db5a8ad397">Mat_invert</a>(<a class="code" href="namespacecontrol__variables.html#afae70ecf2800b85b5556f11ef27e1083">xjac</a>)                  
<a name="l00088"></a>00088                     <span class="keyword">do</span> i = 1,nvecLen
<a name="l00089"></a>00089                       <span class="keyword">do</span> j = 1,nvecLen
<a name="l00090"></a>00090                         <a class="code" href="namespacecontrol__variables.html#af26d46d355bee6c749bf25537333f463">uvec</a>(i) = <a class="code" href="namespacecontrol__variables.html#af26d46d355bee6c749bf25537333f463">uvec</a>(i) - xjacinv(i,j)*Rnewton(j)     <span class="comment">!u^n+1=u^n-J^-1*F</span>
<a name="l00091"></a>00091                       <span class="keyword">enddo</span>
<a name="l00092"></a>00092                     <span class="keyword">enddo</span>  
<a name="l00093"></a>00093                   <span class="keyword">endif</span>
<a name="l00094"></a>00094         
<a name="l00095"></a>00095                   <span class="keyword">if</span>(<a class="code" href="namespaceNewton.html#aef423e4c07ae003b74792dc1b26cea6c">check_exit</a>(uveciter,k)) exit
<a name="l00096"></a>00096                   
<a name="l00097"></a>00097                 <span class="keyword">enddo</span>
<a name="l00098"></a>00098                 
<a name="l00099"></a>00099               <span class="keyword">endif</span>                
<a name="l00100"></a>00100           <span class="keyword">end select</span> Jac_select 
<a name="l00101"></a>00101       <span class="keyword">end select</span> temporal_select
<a name="l00102"></a>00102 <span class="keyword">      end subroutine Newton_Iteration</span>
<a name="l00103"></a>00103       
<a name="l00104"></a>00104 <span class="comment">!==============================================================================</span>
<a name="l00105"></a>00105 <span class="comment">! EXITS NEWTON ITERATION</span>
<a name="l00106"></a><a class="code" href="namespaceNewton.html#aef423e4c07ae003b74792dc1b26cea6c">00106</a>       <span class="keyword">function </span><a class="code" href="namespaceNewton.html#aef423e4c07ae003b74792dc1b26cea6c">check_exit</a>(uveciter,k)
<a name="l00107"></a>00107       
<a name="l00108"></a>00108       use <span class="keywordflow">control_variables</span>, only: tol,uvec
<a name="l00109"></a>00109       
<a name="l00110"></a>00110       <span class="keywordtype">real(wp)</span>, <span class="keywordtype">dimension(:)</span>, <span class="keywordtype">intent(in)</span> :: uveciter
<a name="l00111"></a>00111       <span class="keywordtype">integer</span>,                <span class="keywordtype">intent(in)</span> :: k
<a name="l00112"></a>00112       <span class="keywordtype">real(wp)                           </span>:: tmp
<a name="l00113"></a>00113       <span class="keywordtype">logical</span>                            :: check_exit
<a name="l00114"></a>00114       
<a name="l00115"></a>00115       check_exit=.false.
<a name="l00116"></a>00116       tmp = sum(abs(<a class="code" href="namespacecontrol__variables.html#af26d46d355bee6c749bf25537333f463">uvec</a>(:)-uveciter(:))) <span class="comment">!check accuracy of zeros         </span>
<a name="l00117"></a>00117       <span class="keyword">if</span> (k&gt;=7) <span class="keyword">write</span>(*,*)<span class="stringliteral">&apos;tmp&apos;</span>,tmp,<span class="stringliteral">&apos;k&apos;</span>,k
<a name="l00118"></a>00118       <span class="keyword">if</span> (tmp/=tmp) <span class="keyword">then</span>
<a name="l00119"></a>00119         print*,<span class="stringliteral">&apos;stopping NaN k=&apos;</span>,k
<a name="l00120"></a>00120         stop
<a name="l00121"></a>00121       <span class="keyword">endif</span>      
<a name="l00122"></a>00122       <span class="keyword">if</span>(tmp &lt; <a class="code" href="namespacecontrol__variables.html#ad119e0e43b798a9df022f32defb2719c">tol</a>) check_exit=.true. 
<a name="l00123"></a>00123       
<a name="l00124"></a>00124 <span class="keyword">      end function check_exit</span>
<a name="l00125"></a>00125 <span class="comment">!==============================================================================</span>
<a name="l00126"></a>00126 <span class="comment">!  CREATES RNEWTON FOR NEWTON ITERATION      </span>
<a name="l00127"></a><a class="code" href="namespaceNewton.html#ad1d75574149095632fdf22abe98107da">00127</a>       <span class="keyword">function </span><a class="code" href="namespaceNewton.html#ad1d75574149095632fdf22abe98107da">Build_Rnewton</a>(ep,dt,time,aI,iprob,L)
<a name="l00128"></a>00128       
<a name="l00129"></a>00129       use <span class="keywordflow">control_variables</span>, only: uvec,usum,resI,programstep
<a name="l00130"></a>00130       use <span class="keywordflow">problemsub_mod</span>,    only: problemsub
<a name="l00131"></a>00131             
<a name="l00132"></a>00132       <span class="keywordtype">real(wp)</span>, dimension(size(uvec))       :: Build_Rnewton
<a name="l00133"></a>00133       <span class="keywordtype">real(wp)</span>,               <span class="keywordtype">intent(in   )</span> :: ep,dt,time,aI
<a name="l00134"></a>00134       <span class="keywordtype">integer</span>,                <span class="keywordtype">intent(in   )</span> :: iprob,L
<a name="l00135"></a>00135 
<a name="l00136"></a>00136       <span class="keywordtype">integer</span>  :: iDT,nveclen
<a name="l00137"></a>00137       <span class="keywordtype">real(wp) </span>:: tfinal,dt_in
<a name="l00138"></a>00138       
<a name="l00139"></a>00139       dt_in=dt
<a name="l00140"></a>00140       
<a name="l00141"></a>00141       programStep=<span class="stringliteral">&apos;BUILD_RHS&apos;</span>
<a name="l00142"></a>00142       call <a class="code" href="namespaceproblemsub__mod.html#aa97c50c979947f803ea67b9c23bac057">problemsub</a>(iprob,nveclen,ep,dt_in,tfinal,iDT,time,aI,L)
<a name="l00143"></a>00143       Build_Rnewton(:) = uvec(:)-aI*<a class="code" href="namespacecontrol__variables.html#a622a60898014b0384693ee589b049bcc">resI</a>(:,L)-<a class="code" href="namespacecontrol__variables.html#adb75fde9a143a0e98e889020a87a9f4c">usum</a>(:)
<a name="l00144"></a>00144 
<a name="l00145"></a>00145 <span class="keyword">      end function Build_Rnewton</span>
<a name="l00146"></a>00146 <span class="comment">!==============================================================================</span>
<a name="l00147"></a>00147 <span class="comment">!  CREATES JACOBIAN FOR NEWTON ITERATION      </span>
<a name="l00148"></a><a class="code" href="namespaceNewton.html#a52bc9902166475d40c85f9e38bc2762f">00148</a>       <span class="keyword">subroutine </span><a class="code" href="namespaceNewton.html#a52bc9902166475d40c85f9e38bc2762f">Build_Jac</a>(ep,dt,time,aI,iprob,L)
<a name="l00149"></a>00149       
<a name="l00150"></a>00150       use <span class="keywordflow">control_variables</span>, only: programstep
<a name="l00151"></a>00151       use <span class="keywordflow">problemsub_mod</span>,    only: problemsub     
<a name="l00152"></a>00152        
<a name="l00153"></a>00153       <span class="keywordtype">real(wp)</span>, <span class="keywordtype">intent(in)</span> :: ep,dt,time,aI
<a name="l00154"></a>00154       <span class="keywordtype">integer</span>,  <span class="keywordtype">intent(in)</span> :: iprob,L
<a name="l00155"></a>00155     
<a name="l00156"></a>00156       <span class="keywordtype">integer</span>  :: nveclen
<a name="l00157"></a>00157       <span class="keywordtype">real(wp) </span>:: tfinal,dt_in
<a name="l00158"></a>00158       <span class="keywordtype">integer</span>  :: iDT
<a name="l00159"></a>00159       
<a name="l00160"></a>00160       dt_in=dt
<a name="l00161"></a>00161   
<a name="l00162"></a>00162       programStep=<span class="stringliteral">&apos;BUILD_JACOBIAN&apos;</span>
<a name="l00163"></a>00163       call <a class="code" href="namespaceproblemsub__mod.html#aa97c50c979947f803ea67b9c23bac057">problemsub</a>(iprob,nveclen,ep,dt_in,tfinal,iDT,time,aI,L)
<a name="l00164"></a>00164       
<a name="l00165"></a>00165 <span class="keyword">      end subroutine Build_Jac</span>
<a name="l00166"></a>00166       
<a name="l00167"></a>00167 <span class="comment">!==============================================================================</span>
<a name="l00168"></a>00168 <span class="comment">! PERFORMS LU DECOMPOSITION AND SOLVING</span>
<a name="l00169"></a><a class="code" href="namespaceNewton.html#a5adc17d0f2ed00ec420a7d37c5ac6aa8">00169</a>       <span class="keyword">subroutine </span><a class="code" href="namespaceNewton.html#a5adc17d0f2ed00ec420a7d37c5ac6aa8">LU_solver</a>(Rnewton)
<a name="l00170"></a>00170       
<a name="l00171"></a>00171       use <span class="keywordflow">control_variables</span>, only: uvec      
<a name="l00172"></a>00172       use <span class="keywordflow">Jacobian_CSR_Mod</span>,  only: iaJac,jaJac,aJac,aLUJac,jLUJac,jUJac
<a name="l00173"></a>00173       use <span class="keywordflow">ilut_module</span>,       only: lusol,ilutp
<a name="l00174"></a>00174       
<a name="l00175"></a>00175       <span class="keywordtype">real(wp)</span>, <span class="keywordtype">dimension(:)               </span>:: Rnewton
<a name="l00176"></a>00176       <span class="keywordtype">integer</span>                              :: nveclen,ierr=0
<a name="l00177"></a>00177       <span class="keywordtype">real(wp)</span>, dimension(size(Rnewton))   :: r_wrk
<a name="l00178"></a>00178       <span class="keywordtype">real(wp)</span>, dimension(size(Rnewton))   :: w  
<a name="l00179"></a>00179       <span class="keywordtype">integer</span>,  dimension(2*size(Rnewton)) :: jw,iperm
<a name="l00180"></a>00180       nveclen=<span class="keyword">size</span>(Rnewton)   
<a name="l00181"></a>00181 
<a name="l00182"></a>00182       call <a class="code" href="namespaceilut__module.html#ad2dfc634059838c06576bb536201c969">ilutp</a>(nveclen,<a class="code" href="namespaceJacobian__CSR__Mod.html#a7f4fdf9a3cd9df4f89b43e74e69f16e5">aJac</a>,<a class="code" href="namespaceJacobian__CSR__Mod.html#a5926dc41c54f00cbd2cc669cc175665b">jaJac</a>,<a class="code" href="namespaceJacobian__CSR__Mod.html#a94d69662ef031c9f945e105441d48c02">iaJac</a>,nveclen,1e-13_wp,0.1_wp,nveclen, &amp;
<a name="l00183"></a>00183      &amp;           <a class="code" href="namespaceJacobian__CSR__Mod.html#a7faad8760d974f02d15989cc31b7824d">aLUJac</a>,<a class="code" href="namespaceJacobian__CSR__Mod.html#ac94c0aa2762ba83e3b3f7b2a22d4c4cb">jLUJac</a>,<a class="code" href="namespaceJacobian__CSR__Mod.html#a503c966175f15e65a461a9fcd94aa0bf">jUJac</a>,<span class="keyword">size</span>(alujac),w,jw,iperm,ierr)
<a name="l00184"></a>00184 
<a name="l00185"></a>00185       call <a class="code" href="namespaceilut__module.html#ada9ad893ef908f8521faba7bb0d9b867">lusol</a>(nveclen,Rnewton,r_wrk,<a class="code" href="namespaceJacobian__CSR__Mod.html#a7faad8760d974f02d15989cc31b7824d">aLUJac</a>,<a class="code" href="namespaceJacobian__CSR__Mod.html#ac94c0aa2762ba83e3b3f7b2a22d4c4cb">jLUJac</a>,<a class="code" href="namespaceJacobian__CSR__Mod.html#a503c966175f15e65a461a9fcd94aa0bf">jUJac</a>)
<a name="l00186"></a>00186       <a class="code" href="namespacecontrol__variables.html#af26d46d355bee6c749bf25537333f463">uvec</a>(:)=<a class="code" href="namespacecontrol__variables.html#af26d46d355bee6c749bf25537333f463">uvec</a>(:)-r_wrk(:)        
<a name="l00187"></a>00187 
<a name="l00188"></a>00188       <span class="keyword">if</span> (ierr/=0) <span class="keyword">then</span> 
<a name="l00189"></a>00189         print*,<span class="stringliteral">&apos;Error in LU_solver!&apos;</span>
<a name="l00190"></a>00190         print*,<span class="stringliteral">&apos;ierr=&apos;</span>,ierr
<a name="l00191"></a>00191         stop
<a name="l00192"></a>00192       <span class="keyword">endif</span>
<a name="l00193"></a>00193 <span class="keyword">      end subroutine LU_solver </span>
<a name="l00194"></a>00194 
<a name="l00195"></a>00195 <span class="comment">!==============================================================================</span>
<a name="l00196"></a>00196 <span class="comment">!  PERFORMS LINE SEARCH AND NEWTON ITERATION </span>
<a name="l00197"></a><a class="code" href="namespaceNewton.html#aa2841efcdb8dfb34b1a57b88229f8e4c">00197</a>       <span class="keyword">subroutine </span><a class="code" href="namespaceNewton.html#aa2841efcdb8dfb34b1a57b88229f8e4c">newt_line_search</a>(iprob,L,ep,dt,nveclen,time,aI,icount,k)
<a name="l00198"></a>00198       
<a name="l00199"></a>00199       use <span class="keywordflow">control_variables</span>, only: uvec,xjac
<a name="l00200"></a>00200       
<a name="l00201"></a>00201       <span class="keywordtype">integer</span>,  <span class="keywordtype">intent(in   )</span> :: iprob,L
<a name="l00202"></a>00202       <span class="keywordtype">real(wp)</span>, <span class="keywordtype">intent(in   )</span> :: ep,dt
<a name="l00203"></a>00203       <span class="keywordtype">integer</span>,  <span class="keywordtype">intent(in   )</span> :: nveclen
<a name="l00204"></a>00204       <span class="keywordtype">real(wp)</span>, <span class="keywordtype">intent(in   )</span> :: time,aI
<a name="l00205"></a>00205       <span class="keywordtype">integer</span>,  <span class="keywordtype">intent(inout)</span> :: icount,k
<a name="l00206"></a>00206       
<a name="l00207"></a>00207       <span class="keywordtype">integer</span>                              :: j  <span class="comment">!Do loop variables</span>
<a name="l00208"></a>00208       <span class="keywordtype">integer</span>                              :: ierr
<a name="l00209"></a>00209       <span class="keywordtype">real(wp)</span>, <span class="keywordtype">dimension(nveclen)         </span>:: Rnewton,ustor <span class="comment">!Newton </span>
<a name="l00210"></a>00210       <span class="keywordtype">real(wp)</span>, <span class="keywordtype">dimension(nveclen,nveclen) </span>:: xjacinv <span class="comment">!Jacobianxjac,</span>
<a name="l00211"></a>00211 
<a name="l00212"></a>00212       <span class="keywordtype">real(wp) </span>:: al,rnorm,rnormt
<a name="l00213"></a>00213       <span class="keywordtype">real(wp)</span>, <span class="keywordtype">dimension(nveclen) </span>:: dxi
<a name="l00214"></a>00214       
<a name="l00215"></a>00215       <span class="keyword">do</span> k = 1,150
<a name="l00216"></a>00216         icount = icount + 1
<a name="l00217"></a>00217    
<a name="l00218"></a>00218         Rnewton=<a class="code" href="namespaceNewton.html#ad1d75574149095632fdf22abe98107da">Build_Rnewton</a>(ep,dt,time,aI,iprob,L)
<a name="l00219"></a>00219     
<a name="l00220"></a>00220         rnorm = sqrt(dot_product(Rnewton(:),Rnewton(:)))
<a name="l00221"></a>00221 
<a name="l00222"></a>00222         call <a class="code" href="namespaceNewton.html#a52bc9902166475d40c85f9e38bc2762f">Build_Jac</a>(ep,dt,time,aI,iprob,L)
<a name="l00223"></a>00223 
<a name="l00224"></a>00224         xjacinv=<a class="code" href="namespaceNewton.html#a7ac79898ae2c29247d9712db5a8ad397">Mat_invert</a>(<a class="code" href="namespacecontrol__variables.html#afae70ecf2800b85b5556f11ef27e1083">xjac</a>)
<a name="l00225"></a>00225 
<a name="l00226"></a>00226         dxi = MatMul(xjacinv,Rnewton(:))
<a name="l00227"></a>00227 
<a name="l00228"></a>00228         al = 1.0_wp
<a name="l00229"></a>00229         <span class="keyword">do</span> j = 1,10    <span class="comment">!   under-relax the value of the parameter alpha</span>
<a name="l00230"></a>00230         
<a name="l00231"></a>00231           ustor(:)=<a class="code" href="namespacecontrol__variables.html#af26d46d355bee6c749bf25537333f463">uvec</a>(:)<span class="comment">!becuause uvec is global, it needs to be temp</span>
<a name="l00232"></a>00232                           <span class="comment">!stored so that calculations are done correctly</span>
<a name="l00233"></a>00233           <a class="code" href="namespacecontrol__variables.html#af26d46d355bee6c749bf25537333f463">uvec</a>(:) = <a class="code" href="namespacecontrol__variables.html#af26d46d355bee6c749bf25537333f463">uvec</a>(:) - al*dxi
<a name="l00234"></a>00234              
<a name="l00235"></a>00235           Rnewton=<a class="code" href="namespaceNewton.html#ad1d75574149095632fdf22abe98107da">Build_Rnewton</a>(ep,dt,time,aI,iprob,L)
<a name="l00236"></a>00236     
<a name="l00237"></a>00237           rnormt = sqrt(dot_product(Rnewton(:),Rnewton(:)))
<a name="l00238"></a>00238 
<a name="l00239"></a>00239           <a class="code" href="namespacecontrol__variables.html#af26d46d355bee6c749bf25537333f463">uvec</a>(:)=ustor(:)<span class="comment">!reset uvec from temp storage</span>
<a name="l00240"></a>00240 
<a name="l00241"></a>00241            <span class="keyword">if</span>((rnormt &gt;= rnorm) .and. (rnorm &gt;= 1.0e-4_wp)) <span class="keyword">then</span>
<a name="l00242"></a>00242              al = 0.5_wp * al
<a name="l00243"></a>00243            <span class="keyword">else</span>
<a name="l00244"></a>00244              exit
<a name="l00245"></a>00245            <span class="keyword">endif</span>
<a name="l00246"></a>00246         <span class="keyword">enddo</span>
<a name="l00247"></a>00247 
<a name="l00248"></a>00248         <a class="code" href="namespacecontrol__variables.html#af26d46d355bee6c749bf25537333f463">uvec</a>(:) = <a class="code" href="namespacecontrol__variables.html#af26d46d355bee6c749bf25537333f463">uvec</a>(:) - al*dxi
<a name="l00249"></a>00249 
<a name="l00250"></a>00250         rnorm = rnormt
<a name="l00251"></a>00251        <span class="keyword">if</span> (k &gt;= 140) print*,<span class="stringliteral">&apos;L&apos;</span>,L,<span class="stringliteral">&apos;k&apos;</span>,k,<span class="stringliteral">&apos;tmp&apos;</span>,rnorm,<span class="stringliteral">&apos;j&apos;</span>,j
<a name="l00252"></a>00252         <span class="keyword">if</span>(rnorm &lt;= 1.0e-9_wp) <span class="keyword">then</span>
<a name="l00253"></a>00253           ierr = 0
<a name="l00254"></a>00254           return
<a name="l00255"></a>00255         <span class="keyword">endif</span>
<a name="l00256"></a>00256       <span class="keyword">enddo</span>      
<a name="l00257"></a>00257 <span class="keyword">      end subroutine newt_line_search</span>
<a name="l00258"></a>00258       
<a name="l00259"></a>00259 <span class="comment">!==============================================================================</span>
<a name="l00260"></a>00260 <span class="comment">!  PEFORMS QR DECOMPOSITION USING QR MODULE       </span>
<a name="l00261"></a><a class="code" href="namespaceNewton.html#a7401a28af829eff4c6cf2028df648521">00261</a>       <span class="keyword">subroutine </span><a class="code" href="namespaceNewton.html#a7401a28af829eff4c6cf2028df648521">QR_decomp</a>(mat,nveclen,Rnewton)
<a name="l00262"></a>00262       
<a name="l00263"></a>00263       use <span class="keywordflow">control_variables</span>, only: uvec
<a name="l00264"></a>00264       use <span class="keywordflow">QR_Module</span>, only:qrdcmp,qrsolv
<a name="l00265"></a>00265       
<a name="l00266"></a>00266       <span class="keywordtype">real(wp)</span>, <span class="keywordtype">dimension(:,:)</span>, <span class="keywordtype">intent(inout)</span> :: mat
<a name="l00267"></a>00267       <span class="keywordtype">integer</span>,                  <span class="keywordtype">intent(in   )</span> :: nveclen
<a name="l00268"></a>00268       <span class="keywordtype">real(wp)</span>, <span class="keywordtype">dimension(:)</span>,   <span class="keywordtype">intent(inout)</span> :: Rnewton
<a name="l00269"></a>00269       
<a name="l00270"></a>00270       <span class="keywordtype">real(wp)</span>, <span class="keywordtype">dimension(nveclen) </span>:: wrk_c,wrk_d
<a name="l00271"></a>00271       <span class="keywordtype">logical</span>                      :: snglr
<a name="l00272"></a>00272       
<a name="l00273"></a>00273       call <a class="code" href="namespaceQR__Module.html#a8032282fb03c7c04c3af740fa05a41e7">qrdcmp</a>(mat,nveclen,nveclen,wrk_c,wrk_d,snglr)
<a name="l00274"></a>00274       <span class="keyword">if</span> (snglr) <span class="keyword">then</span>
<a name="l00275"></a>00275         <span class="keyword">write</span>(*,*)<span class="stringliteral">&apos;matrix is singular in Newton Iteration: Stopping&apos;</span>
<a name="l00276"></a>00276         stop
<a name="l00277"></a>00277       <span class="keyword">else</span>
<a name="l00278"></a>00278         call <a class="code" href="namespaceQR__Module.html#afba1458633ddf4ab6421663561097145">qrsolv</a>(mat,nveclen,nveclen,wrk_c,wrk_d,Rnewton)
<a name="l00279"></a>00279       <span class="keyword">endif</span>
<a name="l00280"></a>00280       <a class="code" href="namespacecontrol__variables.html#af26d46d355bee6c749bf25537333f463">uvec</a>(:)=<a class="code" href="namespacecontrol__variables.html#af26d46d355bee6c749bf25537333f463">uvec</a>(:)-Rnewton(:) 
<a name="l00281"></a>00281 <span class="keyword">      end subroutine QR_decomp       </span>
<a name="l00282"></a>00282       
<a name="l00283"></a>00283 <span class="comment">!==============================================================================</span>
<a name="l00284"></a>00284 <span class="comment">!  INVERTS MATRIX OF SIZE 2X2 TO 4X4</span>
<a name="l00285"></a><a class="code" href="namespaceNewton.html#a7ac79898ae2c29247d9712db5a8ad397">00285</a>       <span class="keyword">function </span><a class="code" href="namespaceNewton.html#a7ac79898ae2c29247d9712db5a8ad397">Mat_invert</a>(mat)
<a name="l00286"></a>00286 
<a name="l00287"></a>00287       <span class="keywordtype">real(wp)</span>, <span class="keywordtype">dimension(:,:)</span>, <span class="keywordtype">intent(in   )</span> :: mat
<a name="l00288"></a>00288       <span class="keywordtype">integer</span>  :: mat_size
<a name="l00289"></a>00289       <span class="keywordtype">real(wp)</span>, dimension(size(mat(:,1)),size(mat(1,:))) :: xinv
<a name="l00290"></a>00290       <span class="keywordtype">real(wp)</span>, dimension(size(mat(:,1)),size(mat(1,:))) :: Mat_invert
<a name="l00291"></a>00291       <span class="keywordtype">real(wp) </span>:: x11,x12,x13,x14
<a name="l00292"></a>00292       <span class="keywordtype">real(wp) </span>:: x21,x22,x23,x24
<a name="l00293"></a>00293       <span class="keywordtype">real(wp) </span>:: x31,x32,x33,x34
<a name="l00294"></a>00294       <span class="keywordtype">real(wp) </span>:: x41,x42,x43,x44
<a name="l00295"></a>00295       <span class="keywordtype">real(wp) </span>:: det,detI   
<a name="l00296"></a>00296 
<a name="l00297"></a>00297       mat_size=<span class="keyword">size</span>(mat(:,1))
<a name="l00298"></a>00298            
<a name="l00299"></a>00299       <span class="keyword">if</span>(mat_size==2)<span class="keyword">then</span>
<a name="l00300"></a>00300         det = (mat(1,1)*mat(2,2)-mat(1,2)*mat(2,1))
<a name="l00301"></a>00301         xinv(1,1) =  mat(2,2)/det
<a name="l00302"></a>00302         xinv(1,2) = -mat(1,2)/det
<a name="l00303"></a>00303         xinv(2,1) = -mat(2,1)/det
<a name="l00304"></a>00304         xinv(2,2) =  mat(1,1)/det
<a name="l00305"></a>00305       elseif(mat_size==3)<span class="keyword">then</span>
<a name="l00306"></a>00306 
<a name="l00307"></a>00307         x11 = mat(1,1)
<a name="l00308"></a>00308         x12 = mat(1,2)
<a name="l00309"></a>00309         x13 = mat(1,3)
<a name="l00310"></a>00310         x21 = mat(2,1)
<a name="l00311"></a>00311         x22 = mat(2,2)
<a name="l00312"></a>00312         x23 = mat(2,3)
<a name="l00313"></a>00313         x31 = mat(3,1)
<a name="l00314"></a>00314         x32 = mat(3,2)
<a name="l00315"></a>00315         x33 = mat(3,3)
<a name="l00316"></a>00316 
<a name="l00317"></a>00317         det = - x13*x22*x31 + x12*x23*x31 +  x13*x21*x32&amp; 
<a name="l00318"></a>00318      &amp;        - x11*x23*x32 - x12*x21*x33 +  x11*x22*x33
<a name="l00319"></a>00319 
<a name="l00320"></a>00320         detI = 1.0_wp/det
<a name="l00321"></a>00321 
<a name="l00322"></a>00322         xinv(1,1) =  (- x23*x32 + x22*x33) * detI
<a name="l00323"></a>00323         xinv(1,2) =  (+ x13*x32 - x12*x33) * detI
<a name="l00324"></a>00324         xinv(1,3) =  (- x13*x22 + x12*x23) * detI
<a name="l00325"></a>00325         xinv(2,1) =  (+ x23*x31 - x21*x33) * detI
<a name="l00326"></a>00326         xinv(2,2) =  (- x13*x31 + x11*x33) * detI
<a name="l00327"></a>00327         xinv(2,3) =  (+ x13*x21 - x11*x23) * detI
<a name="l00328"></a>00328         xinv(3,1) =  (- x22*x31 + x21*x32) * detI
<a name="l00329"></a>00329         xinv(3,2) =  (+ x12*x31 - x11*x32) * detI
<a name="l00330"></a>00330         xinv(3,3) =  (- x12*x21 + x11*x22) * detI
<a name="l00331"></a>00331 
<a name="l00332"></a>00332       elseif(mat_size==4)<span class="keyword">then</span>
<a name="l00333"></a>00333 
<a name="l00334"></a>00334         x11 = mat(1,1)
<a name="l00335"></a>00335         x12 = mat(1,2)
<a name="l00336"></a>00336         x13 = mat(1,3)
<a name="l00337"></a>00337         x14 = mat(1,4)
<a name="l00338"></a>00338         x21 = mat(2,1)
<a name="l00339"></a>00339         x22 = mat(2,2)
<a name="l00340"></a>00340         x23 = mat(2,3)
<a name="l00341"></a>00341         x24 = mat(2,4)
<a name="l00342"></a>00342         x31 = mat(3,1)
<a name="l00343"></a>00343         x32 = mat(3,2)
<a name="l00344"></a>00344         x33 = mat(3,3)
<a name="l00345"></a>00345         x34 = mat(3,4)
<a name="l00346"></a>00346         x41 = mat(4,1)
<a name="l00347"></a>00347         x42 = mat(4,2)
<a name="l00348"></a>00348         x43 = mat(4,3)
<a name="l00349"></a>00349         x44 = mat(4,4)
<a name="l00350"></a>00350 
<a name="l00351"></a>00351         det =&amp; 
<a name="l00352"></a>00352      &amp;  (x14*x23*x32*x41 - x13*x24*x32*x41 - &amp;
<a name="l00353"></a>00353      &amp;   x14*x22*x33*x41 + x12*x24*x33*x41 + &amp;
<a name="l00354"></a>00354      &amp;   x13*x22*x34*x41 - x12*x23*x34*x41 - &amp;
<a name="l00355"></a>00355      &amp;   x14*x23*x31*x42 + x13*x24*x31*x42 + &amp;
<a name="l00356"></a>00356      &amp;   x14*x21*x33*x42 - x11*x24*x33*x42 - &amp;
<a name="l00357"></a>00357      &amp;   x13*x21*x34*x42 + x11*x23*x34*x42 + &amp;
<a name="l00358"></a>00358      &amp;   x14*x22*x31*x43 - x12*x24*x31*x43 - &amp;
<a name="l00359"></a>00359      &amp;   x14*x21*x32*x43 + x11*x24*x32*x43 + &amp;
<a name="l00360"></a>00360      &amp;   x12*x21*x34*x43 - x11*x22*x34*x43 - &amp;
<a name="l00361"></a>00361      &amp;   x13*x22*x31*x44 + x12*x23*x31*x44 + &amp;
<a name="l00362"></a>00362      &amp;   x13*x21*x32*x44 - x11*x23*x32*x44 - &amp;
<a name="l00363"></a>00363      &amp;   x12*x21*x33*x44 + x11*x22*x33*x44)
<a name="l00364"></a>00364 
<a name="l00365"></a>00365         detI = 1.0_wp/det
<a name="l00366"></a>00366 
<a name="l00367"></a>00367         xinv(1,1) = (&amp;
<a name="l00368"></a>00368      &amp; -(x24*x33*x42) + x23*x34*x42 + x24*x32*x43 - &amp;
<a name="l00369"></a>00369      &amp;   x22*x34*x43  - x23*x32*x44 + x22*x33*x44  ) * detI
<a name="l00370"></a>00370         xinv(1,2) = (&amp;
<a name="l00371"></a>00371      &amp;   x14*x33*x42  - x13*x34*x42 - x14*x32*x43 + &amp;
<a name="l00372"></a>00372      &amp;   x12*x34*x43  + x13*x32*x44 - x12*x33*x44  ) * detI
<a name="l00373"></a>00373         xinv(1,3) = (&amp;
<a name="l00374"></a>00374      &amp; -(x14*x23*x42) + x13*x24*x42 + x14*x22*x43 - &amp;
<a name="l00375"></a>00375      &amp;   x12*x24*x43  - x13*x22*x44 + x12*x23*x44  ) * detI
<a name="l00376"></a>00376         xinv(1,4) = (&amp;
<a name="l00377"></a>00377      &amp;   x14*x23*x32  - x13*x24*x32 - x14*x22*x33 + &amp;
<a name="l00378"></a>00378      &amp;   x12*x24*x33  + x13*x22*x34 - x12*x23*x34  ) * detI
<a name="l00379"></a>00379         xinv(2,1) = (&amp;
<a name="l00380"></a>00380      &amp;   x24*x33*x41  - x23*x34*x41 - x24*x31*x43 + &amp;
<a name="l00381"></a>00381      &amp;   x21*x34*x43  + x23*x31*x44 - x21*x33*x44  ) * detI
<a name="l00382"></a>00382         xinv(2,2) = (&amp;
<a name="l00383"></a>00383      &amp; -(x14*x33*x41) + x13*x34*x41 + x14*x31*x43 - &amp;
<a name="l00384"></a>00384      &amp;   x11*x34*x43  - x13*x31*x44 + x11*x33*x44  ) * detI
<a name="l00385"></a>00385         xinv(2,3) = (&amp;
<a name="l00386"></a>00386      &amp;   x14*x23*x41  - x13*x24*x41 - x14*x21*x43 + &amp;
<a name="l00387"></a>00387      &amp;   x11*x24*x43  + x13*x21*x44 - x11*x23*x44  ) * detI
<a name="l00388"></a>00388         xinv(2,4) = (&amp;
<a name="l00389"></a>00389      &amp; -(x14*x23*x31) + x13*x24*x31 + x14*x21*x33 - &amp;
<a name="l00390"></a>00390      &amp;   x11*x24*x33  - x13*x21*x34 + x11*x23*x34  ) * detI
<a name="l00391"></a>00391         xinv(3,1) = (&amp;
<a name="l00392"></a>00392      &amp; -(x24*x32*x41) + x22*x34*x41 + x24*x31*x42 - &amp;
<a name="l00393"></a>00393      &amp;   x21*x34*x42  - x22*x31*x44 + x21*x32*x44  ) * detI
<a name="l00394"></a>00394         xinv(3,2) = (&amp;
<a name="l00395"></a>00395      &amp;   x14*x32*x41  - x12*x34*x41 - x14*x31*x42 + &amp;
<a name="l00396"></a>00396      &amp;   x11*x34*x42  + x12*x31*x44 - x11*x32*x44  ) * detI
<a name="l00397"></a>00397         xinv(3,3) = (&amp;
<a name="l00398"></a>00398      &amp; -(x14*x22*x41) + x12*x24*x41 + x14*x21*x42 - &amp;
<a name="l00399"></a>00399      &amp;   x11*x24*x42  - x12*x21*x44 + x11*x22*x44  ) * detI
<a name="l00400"></a>00400         xinv(3,4) = (&amp;
<a name="l00401"></a>00401      &amp;   x14*x22*x31  - x12*x24*x31 - x14*x21*x32 + &amp;
<a name="l00402"></a>00402      &amp;   x11*x24*x32  + x12*x21*x34 - x11*x22*x34  ) * detI
<a name="l00403"></a>00403         xinv(4,1) = (&amp;
<a name="l00404"></a>00404      &amp;   x23*x32*x41  - x22*x33*x41 - x23*x31*x42 + &amp;
<a name="l00405"></a>00405      &amp;   x21*x33*x42  + x22*x31*x43 - x21*x32*x43  ) * detI
<a name="l00406"></a>00406         xinv(4,2) = (&amp;
<a name="l00407"></a>00407      &amp; -(x13*x32*x41) + x12*x33*x41 + x13*x31*x42 - &amp;
<a name="l00408"></a>00408      &amp;   x11*x33*x42  - x12*x31*x43 + x11*x32*x43  ) * detI
<a name="l00409"></a>00409         xinv(4,3) = (&amp;
<a name="l00410"></a>00410      &amp;   x13*x22*x41  - x12*x23*x41 - x13*x21*x42 + &amp;
<a name="l00411"></a>00411      &amp;   x11*x23*x42  + x12*x21*x43 - x11*x22*x43  ) * detI
<a name="l00412"></a>00412         xinv(4,4) = (&amp;
<a name="l00413"></a>00413      &amp; -(x13*x22*x31) + x12*x23*x31 + x13*x21*x32 - &amp;
<a name="l00414"></a>00414      &amp;   x11*x23*x32  - x12*x21*x33 + x11*x22*x33  ) * detI
<a name="l00415"></a>00415       <span class="keyword">endif</span>
<a name="l00416"></a>00416       Mat_invert=xinv
<a name="l00417"></a>00417       return
<a name="l00418"></a>00418 <span class="keyword">      end function Mat_invert</span>
<a name="l00419"></a>00419 <span class="comment">!==============================================================================</span>
<a name="l00420"></a><a class="code" href="namespaceNewton.html#a87f5936737bd590d30d903cc00524ef8">00420</a>       <span class="keyword">subroutine </span><a class="code" href="namespaceNewton.html#a87f5936737bd590d30d903cc00524ef8">Convert_to_CSR</a>(a)
<a name="l00421"></a>00421  
<a name="l00422"></a>00422       use <span class="keywordflow">Jacobian_CSR_Mod</span>, only: Allocate_Jac_CSR_Storage,iaJac,jaJac,aJac      
<a name="l00423"></a>00423       
<a name="l00424"></a>00424       <span class="keywordtype">real(wp)</span>, <span class="keywordtype">dimension(:,:)</span>, <span class="keywordtype">intent(in   )</span> :: a
<a name="l00425"></a>00425       <span class="keywordtype">integer</span>                                 :: i,j,icnt,jcnt,nnz
<a name="l00426"></a>00426       <span class="keywordtype">real(wp)</span>,    <span class="keywordtype">parameter</span>              ::   toljac = 1.0e-13_wp     
<a name="l00427"></a>00427       nnz=<span class="keyword">size</span>(a(:,1))
<a name="l00428"></a>00428 
<a name="l00429"></a>00429       call <a class="code" href="namespaceJacobian__CSR__Mod.html#ab251b185ad5d74ee771ea99d2a7f3935">Allocate_Jac_CSR_Storage</a>(nnz,nnz)
<a name="l00430"></a>00430 
<a name="l00431"></a>00431 <span class="comment">!     U_t = F(U);  Jac = \frac{\partial F(U)}{\partial U};  xjac = I - akk dt Jac</span>
<a name="l00432"></a>00432 
<a name="l00433"></a>00433       <span class="comment">! Initialize CSR</span>
<a name="l00434"></a>00434       <a class="code" href="namespaceJacobian__CSR__Mod.html#a94d69662ef031c9f945e105441d48c02">iaJac</a>(:) = 0
<a name="l00435"></a>00435       <a class="code" href="namespaceJacobian__CSR__Mod.html#a94d69662ef031c9f945e105441d48c02">iaJac</a>(1) = 1
<a name="l00436"></a>00436       <a class="code" href="namespaceJacobian__CSR__Mod.html#a5926dc41c54f00cbd2cc669cc175665b">jaJac</a>(:) = 0 
<a name="l00437"></a>00437       <a class="code" href="namespaceJacobian__CSR__Mod.html#a7f4fdf9a3cd9df4f89b43e74e69f16e5">aJac</a>(:) = 0.0_wp
<a name="l00438"></a>00438       
<a name="l00439"></a>00439       <span class="comment">! Store dense matrix into CSR format</span>
<a name="l00440"></a>00440       icnt = 0   
<a name="l00441"></a>00441       <span class="keyword">do</span> i = 1,nnz
<a name="l00442"></a>00442         jcnt = 0   
<a name="l00443"></a>00443         <span class="keyword">do</span> j = 1,nnz
<a name="l00444"></a>00444           <span class="keyword">if</span>(abs(a(i,j)) &gt;= tolJac) <span class="keyword">then</span>
<a name="l00445"></a>00445             icnt = icnt + 1 
<a name="l00446"></a>00446             jcnt = jcnt + 1 
<a name="l00447"></a>00447              
<a name="l00448"></a>00448             <a class="code" href="namespaceJacobian__CSR__Mod.html#a5926dc41c54f00cbd2cc669cc175665b">jaJac</a>(icnt) = j
<a name="l00449"></a>00449              <a class="code" href="namespaceJacobian__CSR__Mod.html#a7f4fdf9a3cd9df4f89b43e74e69f16e5">aJac</a>(icnt) = a(i,j)
<a name="l00450"></a>00450           <span class="keyword">endif</span>
<a name="l00451"></a>00451         <span class="keyword">enddo</span>
<a name="l00452"></a>00452         <a class="code" href="namespaceJacobian__CSR__Mod.html#a94d69662ef031c9f945e105441d48c02">iaJac</a>(i+1) = <a class="code" href="namespaceJacobian__CSR__Mod.html#a94d69662ef031c9f945e105441d48c02">iaJac</a>(i) + jcnt
<a name="l00453"></a>00453       <span class="keyword">enddo</span>
<a name="l00454"></a>00454 
<a name="l00455"></a>00455 <span class="keyword">      end subroutine Convert_to_CSR</span>
<a name="l00456"></a>00456 <span class="comment">!==============================================================================      </span>
<a name="l00457"></a>00457 <span class="keyword">      end module Newton</span>
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on 2 Aug 2016 for Doxygen Fortran Example by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
